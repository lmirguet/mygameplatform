# mygameplatform

Browser-based multiplayer board-game platform (Connect4 + Draughts (10x10)).

## Repo Layout

- `cmd/` - Go service entrypoints (`auth-service`, `lobby-service`, `game-service`)
- `internal/` - shared/internal packages
- `migrations/` - SQL migrations (source of truth for schema changes)
- `web/` - Vite + React + TypeScript client (build output: `web/dist`)
- `deploy/` - Docker Compose + ingress config
- `_bmad-output/` - planning + implementation artifacts generated by BMAD workflows

## Local Development / Local Deploy

At the moment, `auth-service` is the only service with real behavior; `lobby-service` and `game-service` are stubs (`main()` is empty).

### Prereqs

- Go `1.25.5+` (matches `go.mod`)
- Node.js + npm (for `web/`)
- PostgreSQL 16+ (or run Postgres via Docker)
- Optional: `migrate` CLI (recommended) to apply SQL migrations

If your environment cannot write to `~/.cache` (common in sandboxes/CI), set:

- `GOCACHE="$PWD/.go-cache"`
- `GOMODCACHE="$PWD/.go-modcache"`

### 1) Start Postgres

If you already have Postgres running, skip this.

Using Docker (recommended):

```bash
docker run --rm -d \
  --name mygameplatform-postgres \
  -e POSTGRES_PASSWORD=postgres \
  -e POSTGRES_DB=mygameplatform \
  -p 5432:5432 \
  postgres:16
```

### 2) Configure env vars

Start from the example:

```bash
cp .env.example .env
```

Required env vars for `auth-service`:

- `DATABASE_URL` (e.g. `postgres://postgres:postgres@localhost:5432/mygameplatform?sslmode=disable`)
- `JWT_SIGNING_SECRET` (use a real secret in production)
- Optional: `JWT_TTL_SECONDS` (default: signer decides)
- Optional: `PORT` (default: `8080`)
- Optional: `WEB_DIST_DIR` (default: `web/dist`)

If you run the Vite dev server, set this in `web/.env` (or export it before `npm run dev`):

- `VITE_API_BASE` (e.g. `http://localhost:8080`)

### 3) Apply migrations

Migrations live in `migrations/` (SQL is the source of truth).

Using `golang-migrate/migrate`:

```bash
go install github.com/golang-migrate/migrate/v4/cmd/migrate@latest
migrate -path migrations -database "$DATABASE_URL" up
```

If you prefer Docker for migrations, you can run:

```bash
docker run --rm -v "$PWD/migrations:/migrations" \
  --network=host migrate/migrate \
  -path /migrations -database "$DATABASE_URL" up
```

### 4) Run the backend (auth-service)

```bash
export GOCACHE="$PWD/.go-cache"
export GOMODCACHE="$PWD/.go-modcache"

## load env (bash/zsh)
set -a
source .env
set +a

go run ./cmd/auth-service
```

The API is exposed under `http://localhost:$PORT/api/v1/...` (default `PORT=8080`).

### 5) Run the frontend

You have two options:

**Option A: Serve the built web app from `auth-service` (single origin)**

```bash
cd web
npm ci
npm run build
cd ..

# auth-service auto-serves `WEB_DIST_DIR` when it exists
go run ./cmd/auth-service
```

Then open `http://localhost:8080/`.

**Option B: Use the Vite dev server (best DX)**

```bash
cd web
npm ci
npm run dev
```

If the API is on a different origin, set `VITE_API_BASE` first:

```bash
cd web
echo 'VITE_API_BASE=http://localhost:8080' > .env
npm run dev
```

Then open the Vite URL (usually `http://localhost:5173/`).

### Smoke test (signup)

```bash
curl -sS -X POST "http://localhost:8080/api/v1/auth/signup" \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"password123"}'
```

Expected: JSON with an `access_token`.

### Smoke test (web UI)

1. Start `auth-service` and the web app (Option A or B above).
2. Open the site in a browser.
3. Sign up with a new email/password.
4. Confirm you land on the Profile tab and can update the username.
5. Sign out, then sign in again with the same credentials.

## Local Development (baseline)

- Go checks: `go test ./...`
- Web dev: `cd web && npm install && npm run dev`
- Web prod build: `cd web && npm run build` (outputs static assets to `web/dist`)

## Auth service (static hosting)

`auth-service` serves static assets from `WEB_DIST_DIR` (default: `web/dist`) and exposes auth APIs under `/api/v1/...`.

## Database migrations

Migrations live in `migrations/` (SQL is the source of truth). Apply them with `golang-migrate/migrate`, for example:

- `migrate -path migrations -database "$DATABASE_URL" up`
